<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.85.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>JDBC的使用 &middot; 欢迎来到槎城小子的博客！</title>
  <meta name="description" content="使用JDBC连接MySQL数据库，创建SQL以及执行，批处理还有开启事务，入门c3p0和druid连接池" />

  
  <link type="text/css" rel="stylesheet" href="https://qinry.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://qinry.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://qinry.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://qinry.github.io/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="https://qinry.github.io/css/copy-code-button.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../../apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="../../../../favicon.png">

  
  <link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.1.0/styles/base16/monokai.min.css" rel="stylesheet">

<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>

<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<script src="../../../../js/copy-code-button.js"></script>
<script>hljs.highlightAll();</script>


</head>

  <body class="theme-base-0d ">
    <span id="top"></span>
    <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://qinry.github.io/"><h1>欢迎来到槎城小子的博客！</h1></a>
      <p class="lead">
       不积硅步无以至千里，不积小流无以成江海。 
      </p>
    </div>
    
    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://qinry.github.io/">Home</a> </li>
        <li><a href="https://github.com/qinry"> Github </a></li><li><a href="../../../../tags"> 分类标签 </a></li>
      </ul>
    </nav>

    <p>Copyright © 2021 槎城小子</p>
  </div>
</aside>

    
<aside class="post-toc right-0" style="position:fixed;top: 20px;">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#什么是jdbc">什么是JDBC</a></li>
    <li><a href="#jdbc可以做什么">JDBC可以做什么</a></li>
    <li><a href="#jdbc的核心组件">JDBC的核心组件</a>
      <ul>
        <li><a href="#jdbc基本使用">JDBC基本使用</a></li>
        <li><a href="#使用预状态通道避免sql注入">使用预状态通道避免SQL注入</a></li>
        <li><a href="#jdbc的事务">JDBC的事务</a></li>
        <li><a href="#jdbc批处理">JDBC批处理</a></li>
      </ul>
    </li>
    <li><a href="#数据库连接池">数据库连接池</a>
      <ul>
        <li><a href="#c3p0">c3p0</a></li>
        <li><a href="#druid">druid</a></li>
      </ul>
    </li>
  </ul>
</nav>
    
</aside>


    <main class="content container">
    <div class="post">

  <h1>JDBC的使用</h1>
  <span class="post-date">
    2021-04-02 19:44 &nbsp;
    字数：<strong>1780</strong> &nbsp;
    标签：
              <a href="https://qinry.github.io/tags/mysql/">MySQL</a>&nbsp;
              <a href="https://qinry.github.io/tags/java/">Java</a>&nbsp;
  </span>

  <h2 id="什么是jdbc">什么是JDBC</h2>
<p>JDBC是执行SQL的java API，为关系型数据库提供访问。JDBC可以在更大平台使用像Windows、Mac、Unix等等</p>
<p>JDBC体系由JDBC驱动和JDBC API构成。通过驱动管理器可以连接不同结构的数据库管理系统。</p>
<h2 id="jdbc可以做什么">JDBC可以做什么</h2>
<ol>
<li>创建数据库连接</li>
<li>创建SQL语句</li>
<li>执行SQL查询</li>
<li>查看或修改记录</li>
</ol>
<h2 id="jdbc的核心组件">JDBC的核心组件</h2>
<ol>
<li>DriverManager:通过适合的通讯子协议，Java应用程序和相应数据库驱动程序匹配连接</li>
<li>Driver:处理与数据库服务器的连接，客户端程序很少使用</li>
<li>Connection:通讯的上下文，可以获取连接信息，可以设置MySQL非自动提交开启事务</li>
<li>Statement:将SQL语句提交到数据库</li>
<li>ResultSet:执行查询语句得到的结果集，通过它可以检索数据</li>
<li>SQLException:处理数据相关的异常</li>
</ol>
<h3 id="jdbc基本使用">JDBC基本使用</h3>
<p>使用前需要，导包</p>
<ol>
<li>注册JDBC驱动</li>
</ol>
<pre><code>Class.forName(&quot;com.mysql.jdbc.cj.Driver&quot;);
</code></pre><ol start="2">
<li>数据库配置</li>
</ol>
<pre><code>String url = &quot;jdbc:mysql://localhost:3306/demodb?ServerTimezone=UTC&quot;;
String username = &quot;mysql&quot;;
String password =  &quot;password&quot;;
</code></pre><p>假定mysql服务器监听3306端口，数据库为demodb，服务器时区为UTC。用户名为username，密码为password。</p>
<ol start="3">
<li>打开连接</li>
</ol>
<pre><code>Connection conn = DriverManager.getConnection(url, username, password);
</code></pre><p>打开连接用到上面的三个配置信息</p>
<ol start="4">
<li>创建状态通道</li>
</ol>
<pre><code>tatement stmt = conn.createStatement();
</code></pre><ol start="5">
<li>执行语句</li>
</ol>
<pre><code>String sql = &quot;select id,name from user&quot;;

ResultSet rs = stmt.executeQuery(sql);
// 或
// String name = &quot;xiaoming&quot;;
// String sql2 = &quot;insert into user(name) values(&quot; + name + &quot;)&quot;;
// int count = stmt.executeUpdate(sql2);
</code></pre><p>select语句使用executeQuery，update、insert、delete语句使用executeUpdate</p>
<ol start="6">
<li>得到结果</li>
</ol>
<pre><code>while (rs.next()) {
    int id = rs.getInt(&quot;id&quot;);
    String name = rs.getString(&quot;name&quot;);
    System.out.println(id + &quot; - &quot; + name);
}
// 或
// System.out.println(&quot;改变的行数：&quot;+count);
</code></pre><p>select语句得到使ResultSet的结果，其他语句得到是int类型表示，影响数据库的行数</p>
<ol start="7">
<li>关闭连接</li>
</ol>
<pre><code>try {
    ...
} catch(SQLException e) {
    ...
} finally {
    conn.close();
}
</code></pre><h3 id="使用预状态通道避免sql注入">使用预状态通道避免SQL注入</h3>
<p>PreparedStatement是Statement的子类，支持参数化查询，来防止SQL注入攻击。PreparedStatement还可以预编译SQL语句，使执行SQL的效率更高点</p>
<pre><code>int id = 2;
String sql = &quot;select id, name from user where id=?&quot;;
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setInt(1, id);
rs = pstmt.executeQuery();
</code></pre><h3 id="jdbc的事务">JDBC的事务</h3>
<p>事务常常见于转账</p>
<ol>
<li>开启事务</li>
</ol>
<pre><code>conn.setAutoCommit(false);
</code></pre><p>关闭自动提交</p>
<ol start="2">
<li>回滚</li>
</ol>
<p>遇到异常需要回滚</p>
<pre><code>conn.rollback();
// 或 设置安全点
// Savepoint s1 = conn.setSavepoint(&quot;s1&quot;);
// ...
// 归滚到安全点
// conn.rollback(s1);
</code></pre><ol start="3">
<li>提交</li>
</ol>
<pre><code>conn.commit();
</code></pre><h3 id="jdbc批处理">JDBC批处理</h3>
<p>一次请求，执行多条语句，使用批处理效率更高</p>
<ol>
<li>Statement的批处理</li>
</ol>
<pre><code>Statement stmt = conn.createStatement(sql);
conn.setAutoCommit(false);

stmt.addBatch(INSERT_SQL);

stmt.addBatch(INSERT_SQL_2);

int[] count = stmt.executeBatch();

conn.commit();
</code></pre><ol start="2">
<li>PreparedStatement的批处理</li>
</ol>
<pre><code>conn.setAutoCommit(false);
String sql = &quot;insert into user(name) values(?)&quot;;
PreparedStatement pstmt = conn.prepareStatement(sql);

pstmt.setString(1, &quot;xiaohong&quot;);
pstmt.addBatch();

pstmt.setString(1,&quot;xiaolei&quot;);
pstmt.addBatch();

pstmt.executeBatch();

conn.commit();
</code></pre><h2 id="数据库连接池">数据库连接池</h2>
<p>连接池：系统初始化，将连接作为对象存储在内存中，当有用户需要连接数据库时，第一时间不是创建连接，而是查看连接池是否由空闲的连接，如果有直接使用。使用连接完毕，不是马上关闭资源，而是暂时放回连接池，以便下一次请求使用。</p>
<p>连接池几个重要的参数：</p>
<ol>
<li>初始连接数:连接池启动时的连接数</li>
<li>最小连接数:不管释放空闲连接，数据库至少保持的连接数</li>
<li>最大连接数:大于它的连接排队等待</li>
<li>最大等待时间:池中没有可用连接时，连接池等待连接回归的最大时间</li>
</ol>
<p>有三个常用的连接池</p>
<ol>
<li>c3p0</li>
<li>druid</li>
<li>HikariCP</li>
</ol>
<h3 id="c3p0">c3p0</h3>
<p>首先，导入数据库驱动相关的jar包和c3p0的jar包.
例如：
mysql-connector-java-5.0.8.jar
c3p0-0.9.1.2.jar</p>
<p>c3p0要使用一个默认的配置文件c3p0-config.xml:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;c3p0-config&gt;
    &lt;!-- 默认配置，如果没有指定则使用这个配置 --&gt;
    &lt;default-config&gt; &lt;!-- 基本配置 --&gt;
        &lt;property name=&quot;driverClass&quot;&gt;com.mysql.jdbc.Driver&lt;/property&gt;
        &lt;property name=&quot;jdbcUrl&quot;&gt;jdbc:mysql://localhost:3306/lxq?serverTimezone=UTC&lt;/property&gt;
        &lt;property name=&quot;user&quot;&gt;root&lt;/property&gt;
        &lt;property name=&quot;password&quot;&gt;password&lt;/property&gt;
        &lt;!--扩展配置--&gt; &lt;!-- 连接超过30秒报错--&gt;
        &lt;property name=&quot;checkoutTimeout&quot;&gt;30000&lt;/property&gt;
        &lt;!--30秒检查空闲连接 --&gt;
        &lt;property name=&quot;idleConnectionTestPeriod&quot;&gt;30&lt;/property&gt; &lt;!-- 30秒不使用丢弃--&gt;
        &lt;property name=&quot;initialPoolSize&quot;&gt;10&lt;/property&gt;
        &lt;property name=&quot;maxIdleTime&quot;&gt;30&lt;/property&gt;
        &lt;property name=&quot;maxPoolSize&quot;&gt;100&lt;/property&gt;
        &lt;property name=&quot;minPoolSize&quot;&gt;10&lt;/property&gt;
        &lt;property name=&quot;maxStatements&quot;&gt;200&lt;/property&gt;
    &lt;/default-config&gt;
    &lt;!-- 命名的配置 --&gt;
    &lt;named-config name=&quot;abc&quot;&gt;
        &lt;property name=&quot;driverClass&quot;&gt;com.mysql.jdbc.Driver&lt;/property&gt;
        &lt;property name=&quot;jdbcUrl&quot;&gt;jdbc:mysql://localhost:3306/lxq?serverTimezone=UTC&lt;/property&gt;
        &lt;property name=&quot;user&quot;&gt;root&lt;/property&gt;
        &lt;property name=&quot;password&quot;&gt;111&lt;/property&gt;
        &lt;!-- 如果池中数据连接不够时一次增长多少个 --&gt;
        &lt;property name=&quot;acquireIncrement&quot;&gt;5&lt;/property&gt;
        &lt;property name=&quot;initialPoolSize&quot;&gt;20&lt;/property&gt;
        &lt;property name=&quot;minPoolSize&quot;&gt;10&lt;/property&gt;
        &lt;property name=&quot;maxPoolSize&quot;&gt;40&lt;/property&gt;
        &lt;property name=&quot;maxStatements&quot;&gt;20&lt;/property&gt;
        &lt;property name=&quot;maxStatementsPerConnection&quot;&gt;5&lt;/property&gt;
    &lt;/named-config&gt;
&lt;/c3p0-config&gt;
</code></pre><p>加载配置文件</p>
<pre><code>// 加载c3p0-config.xml中的default-config
ComboPooledDataSource dataSource = new ComboPooledDataSource();
// 加载c3p0-config.xml中的named-config
// ComboPooledDataSource dataSource = new ComboPooledDataSource(&quot;abc&quot;);

</code></pre><p>从数据源中获取连接</p>
<pre><code>Connection conn = dataSource.getConnection();
</code></pre><p>其他与JDBC操作无差别</p>
<h3 id="druid">druid</h3>
<p>首先，同样导入数据库驱动相关的jar包和druid的jar包.
例如：
mysql-connector-java-5.0.8.jar
druid-1.0.9.jar</p>
<p>需要数据库配置相关的properties后缀的文件，比如db.properties</p>
<pre><code class="language-properties" data-lang="properties"># 驱动类名
driverClassName = com.mysql.cj.jdbc.Driver
# 数据库URL
url = jdbc:mysql://localhost:3306/lxq?serverTimezone=UTC
# 数据库用户名
username = root
# 数据用户密码
password = password
# 初始连接数
initialSize=5
# 最大活跃连接数
maxActive = 10
# 最小空闲连接数
minIdle = 5
# 最大等待连接时间，单位毫秒
maxWait = 3000
# 是否测试空闲连接
testWhileIdle = false
</code></pre><pre><code>InputStream in = JDBCUtils.class.getClassLoader().getResourceAsStream(&quot;db.properties&quot;);
Properties properties = new Properties();
properties.load(in);
DruidDataSource dataSource = DruidDataSourceFactory.createDataSource(properties);
</code></pre>
</div>


    </main>
    <a href="#top" class="backtop">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-circle-up" class="svg-inline--fa fa-chevron-circle-up fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <path fill="currentColor" d="M8 256C8 119 119 8 256 8s248 111 248 248-111 248-248 248S8 393 8 256zm231-113.9L103.5 277.6c-9.4 9.4-9.4 24.6 0 33.9l17 17c9.4 9.4 24.6 9.4 33.9 0L256 226.9l101.6 101.6c9.4 9.4 24.6 9.4 33.9 0l17-17c9.4-9.4 9.4-24.6 0-33.9L273 142.1c-9.4-9.4-24.6-9.4-34 0z">
    </path>
    </svg>
</a>
    
      
    
  </body>
</html>
